# package installation
- name: add EPEL
  shell: creates=/etc/yum.repos.d/epel.repo rpm -Uvh --replacepkgs http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm

# pythonがバージョンアップされているため、yumで使用するpythonを明示する
# - name: set ansible_python_interpreter
#   set_fact: ansible_python_interpreter="/usr/bin/python2.6"

# リリース後は手動でupdateしていくためコメントアウト
# - name: yum update
#   yum: name=* state=latest

- name: install basic packages
  yum:
    name:
      - git
      - curl
      - wget
      - libselinux-python
      - ruby-devel
      - readline-devel
      - ncurses-devel
      - gdbm-devel
      - openssl-devel
      - libxslt-devel
      - sqlite-devel
      - mysql-devel
      - libyaml
      - libyaml-devel
      - tcl-devel
      - db4-devel
      - libffi-devel
      - gcc
      - libxml2
      - libxml2-devel
      - libxslt
      - libxslt-devel
      - ImageMagick
      - ImageMagick-devel
      - python-devel

- name: install supervisor
  yum:
    name: supervisor
    state: installed
    enablerepo: epel
  # shell: /usr/bin/pip-2.7 install supervisor
# - name: change use python version in supervisord
#   lineinfile: >-
#     dest='/usr/bin/supervisord'
#     regexp='#!/usr/bin/python'
#     line='#!/usr/bin/python27'
# - name: change use python version in supervisorctl
#   lineinfile: >-
#     dest='/usr/bin/supervisorctl'
#     regexp='#!/usr/bin/python'
#     line='#!/usr/bin/python27'
- name: supervisord config
  template:
    src: supervisord.conf
    dest: /etc/supervisord.conf
    owner: root
    group: root
    mode: 0644
- name: supervisord service
  service: name=supervisord enabled=yes

- name: install Development Tool
  become: yes
  yum: name="@Development tools" state=present

# timezone
- name: set timezone
  file: src=/usr/share/zoneinfo/Asia/Tokyo dest=/etc/localtime state=link force=yes

# hostname
- name: set hostname
  hostname: name={{ hostname }}
- name: set /etc/hosts
  lineinfile: dest=/etc/hosts regexp=^127\.0\.0\.1 line='127.0.0.1 {{ hostname }} localhost localhost.localdomain'

- name: setup ld.so.conf
  template:
    src: ld.so.conf
    dest: /etc/ld.so.conf
    owner: root
    group: root
    mode: 0644
- name: execute ldconfig
  shell: /sbin/ldconfig
  become: true

# mojimoji0.0.9をpipでインストール時にエラーが発生する問題に対応
- name: create cc1plus symbolic link
  file:
    src: /usr/libexec/gcc/x86_64-amazon-linux/4.8.5/cc1plus
    dest: /usr/bin/cc1plus
    state: link

# ウイルス対策を導入
- name: install clamav
  yum:
    name:
      - clamav
      - clamav-update
- name: clamav config
  template:
    src: fleshclam.conf
    dest: /etc/freshclam.conf
    owner: root
    group: root
    mode: 0644

- name: schedule update
  cron:
    name: clamav update
    weekday: 1
    minute: 0
    hour: 4
    user: root
    job: "/usr/share/clamav/freshclam-sleep"
    cron_file: clamav-update

- name: create scan log dirctory
  file:
    path: /var/log/clamav
    state: directory
    owner: root
    group: root
    mode: 0755

- name: create scan log
  file:
    path: /var/log/clamav/clamscan.log
    state: touch
    owner: root
    group: root
    mode: 0644
    
- name: schedule scan
  cron:
    name: clamav scan
    weekday: 1
    minute: 0
    hour: 5
    user: root
    job: "clamscan / -r -l /var/log/clamav/clamscan.log -i --exclude-dir='/sys|/etc|/bin|/var' --quiet; echo 'Started at:' `date -R` >> /var/log/clamav/clamscan.log"
    cron_file: clamav-scan